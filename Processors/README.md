# Shared Processors

These are [Autopkg Processors](https://github.com/autopkg/autopkg/wiki/Processors) to
fill needs unmet by existing Processors.

## XMLModifier

This processor can be used to modify XML files by adding, removing, or changing
elements. This can be use, for example, to modify an unpacked flat package's
`PackageInfo` file, perhaps by removing the `relocate` element to disable bundle
relocation.

### Example Usage

```xml
<dict>
    <key>Arguments</key>
    <dict>
        <key>xml_file</key>
        <string>%RECIPE_CACHE_DIR%/unpack/PackageInfo</string>
        <key>actions</key>
        <array>
            <dict>
                <key>action</key>
                <string>remove</string>
                <key>xpath</key>
                <string>relocate</string>
            </dict>
        </array>
    </dict>
    <key>Processor</key>
    <string>com.github.ccaviness.processors/XMLModifier</string>
</dict>
```

## FilePatcher

This processor applies a patch to a specified target file using the `patch` command. It
expects a standard patch file generated by the `diff` command, e.g.:

```shell
diff -Naur original_file modified_file > my_patch.patch
```

This can be useful if you wish to make specific edits to a file, without replacing the
file entirely.

*IMPORTANT:* When using `patch_string`, the string should normally be XML-escaped, e.g. `<`
replaced with `&lt;` etc.

### Example Usage

`patch.diff`:

```diff
--- unpack-orig/PackageInfo	2024-10-31 18:04:42
+++ unpack/PackageInfo	2024-10-31 15:45:21
@@ -13,9 +13,6 @@
     <strict-identifier>
         <bundle id="com.okta.mobile"/>
     </strict-identifier>
-    <relocate>
-        <bundle id="com.okta.mobile"/>
-    </relocate>
     <scripts>
         <postinstall file="./postinstall"/>
     </scripts>
\ No newline at end of file
```

Using `patch_file`:

```xml
<dict>
    <key>Arguments</key>
    <dict>
        <key>target_file</key>
        <string>%RECIPE_CACHE_DIR%/unpack/PackageInfo</string>
        <key>patch_file</key>
        <string>/path/to/patch.diff</string>
    </dict>
    <key>Processor</key>
    <string>com.github.ccaviness.processors/FilePatcher</string>
</dict>
```

Using `patch_string`:

```xml
<dict>
    <key>Arguments</key>
    <dict>
        <key>target_file</key>
        <string>%RECIPE_CACHE_DIR%/unpack/PackageInfo</string>
        <key>patch_string</key>
        <string>--- unpack-orig/PackageInfo	2024-10-31 18:04:42
+++ unpack/PackageInfo	2024-10-31 15:45:21
@@ -13,9 +13,6 @@
     &lt;strict-identifier&gt;
         &lt;bundle id=&quot;com.okta.mobile&quot;/&gt;
     &lt;/strict-identifier&gt;
-    &lt;relocate&gt;
-        &lt;bundle id=&quot;com.okta.mobile&quot;/&gt;
-    &lt;/relocate&gt;
     &lt;scripts&gt;
         &lt;postinstall file=&quot;./postinstall&quot;/&gt;
     &lt;/scripts&gt;
\ No newline at end of file
</string>
    </dict>
    <key>Processor</key>
    <string>com.github.ccaviness.processors/FilePatcher</string>
</dict>
```
